---
# tasks file for certbot

- name: Install certbot and Cloudflare DNS plugin
  apt:
    name:
    - certbot
    - python3-certbot-dns-cloudflare
    state: present
    update_cache: yes

- name: Ensure letsencrypt directory exists
  file:
    path: /etc/letsencrypt
    state: directory
    mode: '0755'

- name: Write Cloudflare credentials
  copy:
    dest: /etc/letsencrypt/cloudflare.ini
    owner: root
    group: root
    mode: '0600'
    content: |
      dns_cloudflare_api_token = {{ cloudflare_api_token }}

- name: Deploy certbot cron job file
  copy:
    dest: /etc/cron.d/certbot
    owner: root
    group: root
    mode: '0644'
    content: |
      30 14 * * * certbot certonly --agree-tos --key-type rsa --dns-cloudflare --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini -d wisecode.org,*.wisecode.org,*.snoopy.wisecode.org -n
